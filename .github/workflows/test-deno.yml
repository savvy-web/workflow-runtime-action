name: Test - Deno Runtime

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-deno.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-deno.yml"

jobs:
  test-deno-auto-detect:
    name: Deno - Auto-detect from deno.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: deno-minimal

      - name: Setup Deno (auto-detect)
        id: setup
        uses: ./
        with:
          deno-version: "1.46.3"

      - name: Verify Deno installation
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ¦• Deno Auto-detect Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-runtime: deno
          expected-package-manager: deno

      - name: Test Deno
        run: |
          deno --version
          deno run main.ts

  test-deno-from-package-json:
    name: Deno - Detect from package.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: deno-lockfile

      - name: Setup Deno (from package.json)
        id: setup
        uses: ./

      - name: Verify package.json detection
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ“¦ Deno package.json Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-runtime: deno
          expected-deno-version: "1.46.3"

      - name: Test Deno
        run: deno run app.ts

  test-deno-explicit:
    name: Deno - Explicit version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: deno-minimal

      - name: Setup Deno (explicit version)
        id: setup
        uses: ./
        with:
          package-manager: deno
          deno-version: "1.46.3"

      - name: Verify explicit version
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸŽ¯ Deno Explicit Version Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-deno-version: "1.46.3"

      - name: Test Deno
        run: |
          deno --version
          deno run test.ts

  test-deno-with-dependencies:
    name: Deno - With dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: deno-minimal

      - name: Setup Deno with dependencies
        id: setup
        uses: ./
        with:
          package-manager: deno
          deno-version: "1.46.3"

      - name: Verify setup
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ“¦ Deno Dependencies Test"
          outputs: ${{ toJSON(steps.setup.outputs) }}

      - name: Verify dependencies
        run: |
          # Check deno.lock exists
          if [ ! -f "deno.lock" ]; then
            echo "âŒ deno.lock not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Run file that uses imports
          deno info server.ts

          echo "âœ… Dependencies handled successfully" >> $GITHUB_STEP_SUMMARY

  test-deno-lockfile:
    name: Deno - Lock file handling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: deno-minimal

      - name: Setup Deno with lockfile
        id: setup
        uses: ./
        with:
          package-manager: deno
          deno-version: "1.46.3"

      - name: Verify setup
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ”’ Deno Lockfile Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}

      - name: Verify lockfile
        run: |
          # Verify deno.lock exists
          if [ ! -f "deno.lock" ]; then
            echo "âŒ deno.lock not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          deno run main.ts
          echo "âœ… Lockfile handled correctly" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Deno Tests Summary
    runs-on: ubuntu-latest
    needs:
      [
        test-deno-auto-detect,
        test-deno-from-package-json,
        test-deno-explicit,
        test-deno-with-dependencies,
        test-deno-lockfile,
      ]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Deno Runtime Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-detect (deno.json) | ${{ needs.test-deno-auto-detect.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Detect from package.json | ${{ needs.test-deno-from-package-json.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Explicit Version | ${{ needs.test-deno-explicit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| With Dependencies | ${{ needs.test-deno-with-dependencies.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lockfile Handling | ${{ needs.test-deno-lockfile.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all tests passed
          if [ "${{ needs.test-deno-auto-detect.result }}" == "success" ] && \
             [ "${{ needs.test-deno-from-package-json.result }}" == "success" ] && \
             [ "${{ needs.test-deno-explicit.result }}" == "success" ] && \
             [ "${{ needs.test-deno-with-dependencies.result }}" == "success" ] && \
             [ "${{ needs.test-deno-lockfile.result }}" == "success" ]; then
            echo "### âœ… All Deno tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
