name: Test Runtime Action

on:
  workflow_dispatch:
    inputs:
      package-manager:
        description: "Package manager (leave empty for auto-detect)"
        required: false
        default: ""
        type: choice
        options:
          - npm
          - pnpm
          - yarn
      node-version:
        description: "Node.js version (leave empty to use .nvmrc)"
        required: false
        default: ""
      biome-version:
        description: "Biome version (leave empty for auto-detect or skip)"
        required: false
        default: ""
      install-deps:
        description: "Install dependencies"
        required: false
        default: true
        type: boolean
      turbo-token:
        description: "Turbo token (optional)"
        required: false
        default: ""
      turbo-team:
        description: "Turbo team (optional)"
        required: false
        default: ""
  push:
    branches: [main]
    paths:
      - "src/**"
      - "action.yml"
      - ".github/workflows/test-action.yml"
  pull_request:
    paths:
      - "src/**"
      - "action.yml"
      - ".github/workflows/test-action.yml"

jobs:
  test-action:
    name: Test Runtime Setup Action
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run action with current settings
        id: setup
        uses: ./
        with:
          package-manager: ${{ inputs.package-manager || '' }}
          node-version: ${{ inputs.node-version || '' }}
          biome-version: ${{ inputs.biome-version || '' }}
          install-deps: ${{ inputs.install-deps != false }}
          turbo-token: ${{ inputs.turbo-token || '' }}
          turbo-team: ${{ inputs.turbo-team || '' }}

      - name: Display action outputs
        run: |
          echo "## ðŸ“Š Action Outputs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Output | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version | \`${{ steps.setup.outputs.node-version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version File | \`${{ steps.setup.outputs.node-version-file || 'none' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Node Version Source | \`${{ steps.setup.outputs.node-version-source }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Manager | \`${{ steps.setup.outputs.package-manager }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Turbo Enabled | \`${{ steps.setup.outputs.turbo-enabled }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Turbo Config File | \`${{ steps.setup.outputs.turbo-config-file || 'none' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Biome Version | \`${{ steps.setup.outputs.biome-version || 'not configured' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Biome Config File | \`${{ steps.setup.outputs.biome-config-file || 'none' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Hit | \`${{ steps.setup.outputs.cache-hit || 'n/a' }}\` |" >> $GITHUB_STEP_SUMMARY

      - name: Verify Node.js installation
        run: |
          echo "## ðŸ” Environment Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Node.js" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          node --version >> $GITHUB_STEP_SUMMARY
          npm --version >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Node.js path:** \`$(which node)\`" >> $GITHUB_STEP_SUMMARY
          echo "**npm path:** \`$(which npm)\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify package manager installation
        run: |
          PM="${{ steps.setup.outputs.package-manager }}"
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Manager ($PM)" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          case "$PM" in
            pnpm)
              pnpm --version >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "pnpm path: $(which pnpm)" >> $GITHUB_STEP_SUMMARY
              ;;
            yarn)
              yarn --version >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "yarn path: $(which yarn)" >> $GITHUB_STEP_SUMMARY
              ;;
            npm)
              npm --version >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "npm path: $(which npm)" >> $GITHUB_STEP_SUMMARY
              ;;
          esac
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify Turbo detection (if enabled)
        if: steps.setup.outputs.turbo-enabled == 'true'
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Turbo Configuration" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Turbo configuration detected at: \`${{ steps.setup.outputs.turbo-config-file }}\`" >> $GITHUB_STEP_SUMMARY
          if command -v turbo &> /dev/null; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Turbo CLI version:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            turbo --version >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Verify Biome installation (if configured)
        if: steps.setup.outputs.biome-version != ''
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Biome" >> $GITHUB_STEP_SUMMARY
          echo "Expected version: \`${{ steps.setup.outputs.biome-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Installed version:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          biome --version >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Biome path: \`$(which biome)\`" >> $GITHUB_STEP_SUMMARY

      - name: Verify cache status
        if: inputs.install-deps != false
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Cache Status" >> $GITHUB_STEP_SUMMARY
          CACHE_HIT="${{ steps.setup.outputs.cache-hit }}"
          case "$CACHE_HIT" in
            "true")
              echo "âœ… Cache hit - dependencies restored from cache" >> $GITHUB_STEP_SUMMARY
              ;;
            "partial")
              echo "âš¡ Partial cache hit - some dependencies restored from cache" >> $GITHUB_STEP_SUMMARY
              ;;
            "false")
              echo "ðŸ“¦ Cache miss - dependencies installed fresh (will be cached for next run)" >> $GITHUB_STEP_SUMMARY
              ;;
            *)
              echo "â„¹ï¸  Cache status: $CACHE_HIT" >> $GITHUB_STEP_SUMMARY
              ;;
          esac

      - name: Verify dependencies (if installed)
        if: inputs.install-deps != false
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Dependencies" >> $GITHUB_STEP_SUMMARY
          if [ -d "node_modules" ]; then
            echo "âœ… Dependencies installed successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Node modules size:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            du -sh node_modules >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Dependencies not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Test running commands
        if: inputs.install-deps != false
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ§ª Command Tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Test typecheck
          echo "### Type Check" >> $GITHUB_STEP_SUMMARY
          if pnpm typecheck; then
            echo "âœ… Type check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Type check failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Test lint
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Lint" >> $GITHUB_STEP_SUMMARY
          if pnpm lint; then
            echo "âœ… Lint check passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lint check failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Test build/test
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests" >> $GITHUB_STEP_SUMMARY
          if pnpm test; then
            echo "âœ… Tests passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Test summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ job.status }}" == "success" ]; then
            echo "## âœ… All tests passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The runtime action is working correctly with the current configuration." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

  test-matrix:
    name: Test with ${{ matrix.pm }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        pm: [pnpm, npm]
        include:
          # Test yarn only on Ubuntu to save CI time
          - os: ubuntu-latest
            pm: yarn

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Run action with ${{ matrix.pm }}
        id: setup
        uses: ./
        with:
          package-manager: ${{ matrix.pm }}
          install-deps: true

      - name: Verify setup
        shell: bash
        run: |
          echo "Testing with ${{ matrix.pm }} on ${{ matrix.os }}"
          node --version
          ${{ matrix.pm }} --version

      - name: Run quick validation
        shell: bash
        run: |
          # Use the detected package manager
          PM="${{ matrix.pm }}"
          case "$PM" in
            pnpm)
              pnpm typecheck
              ;;
            yarn)
              yarn typecheck
              ;;
            npm)
              npm run typecheck
              ;;
          esac

      - name: Create summary
        if: always()
        shell: bash
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" == "success" ]; then
            ICON="âœ…"
          else
            ICON="âŒ"
          fi
          echo "## $ICON ${{ matrix.os }} / ${{ matrix.pm }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Node Version:** \`${{ steps.setup.outputs.node-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Package Manager:** \`${{ steps.setup.outputs.package-manager }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Cache Hit:** \`${{ steps.setup.outputs.cache-hit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** $STATUS" >> $GITHUB_STEP_SUMMARY

  test-cache-effectiveness:
    name: Test Cache Effectiveness
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: First run (cache miss expected)
        id: setup1
        uses: ./
        with:
          install-deps: true

      - name: Remove node_modules
        run: rm -rf node_modules

      - name: Second run (cache hit expected)
        id: setup2
        uses: ./
        with:
          install-deps: true

      - name: Verify cache effectiveness
        run: |
          echo "## ðŸŽ¯ Cache Effectiveness Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Run | Cache Hit | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| First | \`${{ steps.setup1.outputs.cache-hit }}\` | Expected: false |" >> $GITHUB_STEP_SUMMARY
          echo "| Second | \`${{ steps.setup2.outputs.cache-hit }}\` | Expected: true |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.setup2.outputs.cache-hit }}" == "true" ]; then
            echo "âœ… Cache is working correctly!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Cache did not work as expected" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
