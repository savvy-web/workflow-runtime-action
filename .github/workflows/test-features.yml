name: Test - Features (Biome, Turbo, Cache)

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-features.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-features.yml"

jobs:
  test-biome-auto-detect:
    name: Biome - Auto-detect from config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create project with Biome config
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          npm init -y
          cat > biome.jsonc <<'EOF'
          {
            "$schema": "https://biomejs.dev/schemas/2.3.6/schema.json",
            "linter": {
              "enabled": true
            }
          }
          EOF
          echo 'const x = 1;' > test.js
          cp -r /tmp/action-backup/* .

      - name: Setup with Biome auto-detect
        id: setup
        uses: ./

      - name: Verify Biome installation
        run: |
          echo "## ðŸ§¬ Biome Auto-detect Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Biome Enabled: \`${{ steps.setup.outputs.biome-enabled }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Biome Version: \`${{ steps.setup.outputs.biome-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Biome Config: \`${{ steps.setup.outputs.biome-config-file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify Biome is installed
          biome --version

          # Verify outputs
          if [ "${{ steps.setup.outputs.biome-enabled }}" != "true" ]; then
            echo "âŒ Expected biome-enabled to be true" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ "${{ steps.setup.outputs.biome-version }}" != "2.3.6" ]; then
            echo "âŒ Expected version 2.3.6 from $schema" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ "${{ steps.setup.outputs.biome-config-file }}" != "biome.jsonc" ]; then
            echo "âŒ Expected biome.jsonc config file" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Run Biome check
          biome check test.js

          echo "âœ… Biome auto-detection successful" >> $GITHUB_STEP_SUMMARY

  test-biome-explicit:
    name: Biome - Explicit version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create minimal project
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          npm init -y
          echo 'const y = 2;' > test.js
          cp -r /tmp/action-backup/* .

      - name: Setup with explicit Biome version
        id: setup
        uses: ./
        with:
          biome-version: "2.3.6"

      - name: Verify explicit Biome version
        run: |
          echo "## ðŸŽ¯ Biome Explicit Version Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Biome Enabled: \`${{ steps.setup.outputs.biome-enabled }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Biome Version: \`${{ steps.setup.outputs.biome-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify Biome is installed
          INSTALLED_VERSION=$(biome --version | awk '{print $2}')
          echo "Installed: $INSTALLED_VERSION"

          if [ "${{ steps.setup.outputs.biome-version }}" != "2.3.6" ]; then
            echo "âŒ Expected explicit version 2.3.6" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          biome check test.js
          echo "âœ… Explicit Biome version successful" >> $GITHUB_STEP_SUMMARY

  test-turbo-detection:
    name: Turbo - Monorepo detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create Turbo monorepo
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "turbo-monorepo",
            "version": "1.0.0",
            "packageManager": "pnpm@10.20.0",
            "devDependencies": {
              "turbo": "^2.0.0"
            }
          }
          EOF
          cat > turbo.json <<'EOF'
          {
            "$schema": "https://turbo.build/schema.json",
            "tasks": {
              "build": {
                "dependsOn": ["^build"],
                "outputs": ["dist/**"]
              }
            }
          }
          EOF
          mkdir -p packages/app
          cat > packages/app/package.json <<'EOF'
          {
            "name": "@repo/app",
            "version": "1.0.0"
          }
          EOF
          cp -r /tmp/action-backup/* .

      - name: Setup with Turbo detection
        id: setup
        uses: ./

      - name: Verify Turbo detection
        run: |
          echo "## âš¡ Turbo Detection Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Turbo Enabled: \`${{ steps.setup.outputs.turbo-enabled }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Turbo Config: \`${{ steps.setup.outputs.turbo-config-file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify outputs
          if [ "${{ steps.setup.outputs.turbo-enabled }}" != "true" ]; then
            echo "âŒ Expected turbo-enabled to be true" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          if [ "${{ steps.setup.outputs.turbo-config-file }}" != "turbo.json" ]; then
            echo "âŒ Expected turbo.json config file" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Turbo detection successful" >> $GITHUB_STEP_SUMMARY

  test-cache-effectiveness:
    name: Cache - First run vs cached run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create project with dependencies
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "cache-test",
            "version": "1.0.0",
            "packageManager": "pnpm@10.20.0",
            "dependencies": {
              "lodash": "^4.17.21"
            }
          }
          EOF
          cp -r /tmp/action-backup/* .

      - name: First run (cache miss)
        id: setup1
        uses: ./

      - name: Verify first run
        run: |
          echo "## ðŸ’¾ Cache First Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Cache Hit: \`${{ steps.setup1.outputs.cache-hit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # First run should not have cache hit
          if [ "${{ steps.setup1.outputs.cache-hit }}" == "true" ]; then
            echo "âŒ First run should not have cache hit" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verify dependencies installed
          if [ ! -d "node_modules/lodash" ]; then
            echo "âŒ Dependencies not installed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… First run successful (no cache)" >> $GITHUB_STEP_SUMMARY

      - name: Clear node_modules for second run
        run: rm -rf node_modules

      - name: Second run (cache hit expected)
        id: setup2
        uses: ./

      - name: Verify second run
        run: |
          echo "## ðŸ’¾ Cache Second Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Cache Hit: \`${{ steps.setup2.outputs.cache-hit }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Second run should have cache hit or partial
          if [ "${{ steps.setup2.outputs.cache-hit }}" == "false" ]; then
            echo "âŒ Second run should have cache hit or partial" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verify dependencies still work
          if [ ! -d "node_modules/lodash" ]; then
            echo "âŒ Dependencies not restored from cache" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Cache restoration successful" >> $GITHUB_STEP_SUMMARY

  test-skip-deps:
    name: Skip dependency installation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create project with dependencies
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "skip-deps-test",
            "version": "1.0.0",
            "packageManager": "npm@10.0.0",
            "dependencies": {
              "lodash": "^4.17.21"
            }
          }
          EOF
          cp -r /tmp/action-backup/* .

      - name: Setup with install-deps disabled
        id: setup
        uses: ./
        with:
          install-deps: false

      - name: Verify dependencies not installed
        run: |
          echo "## ðŸš« Skip Dependencies Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime: \`${{ steps.setup.outputs.runtime }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Node Version: \`${{ steps.setup.outputs.node-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify Node.js is installed
          node --version
          npm --version

          # Verify node_modules was NOT created
          if [ -d "node_modules" ]; then
            echo "âŒ node_modules should not exist when install-deps is false" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Dependencies correctly skipped" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Features Tests Summary
    runs-on: ubuntu-latest
    needs:
      [
        test-biome-auto-detect,
        test-biome-explicit,
        test-turbo-detection,
        test-cache-effectiveness,
        test-skip-deps,
      ]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Features Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Biome Auto-detect | ${{ needs.test-biome-auto-detect.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Biome Explicit | ${{ needs.test-biome-explicit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Turbo Detection | ${{ needs.test-turbo-detection.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Effectiveness | ${{ needs.test-cache-effectiveness.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Dependencies | ${{ needs.test-skip-deps.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all tests passed
          if [ "${{ needs.test-biome-auto-detect.result }}" == "success" ] && \
             [ "${{ needs.test-biome-explicit.result }}" == "success" ] && \
             [ "${{ needs.test-turbo-detection.result }}" == "success" ] && \
             [ "${{ needs.test-cache-effectiveness.result }}" == "success" ] && \
             [ "${{ needs.test-skip-deps.result }}" == "success" ]; then
            echo "### âœ… All feature tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
