name: Test - Features (Biome, Turbo, Cache)

on:
  workflow_dispatch:

jobs:
  test-biome-auto-detect:
    name: Biome - Auto-detect from config
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: biome-auto

      - name: Setup with Biome auto-detect
        id: setup
        uses: ./

      - name: Verify Biome installation
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ§¬ Biome Auto-detect Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-biome-enabled: "true"
          expected-biome-version: "2.3.6"
          expected-biome-config-file: biome.jsonc

      - name: Test Biome
        run: biome --version

  test-biome-explicit:
    name: Biome - Explicit version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: node-minimal

      - name: Create test file
        run: echo 'const y = 2;' > test.js

      - name: Setup with explicit Biome version
        id: setup
        uses: ./
        with:
          biome-version: "2.3.6"

      - name: Verify explicit Biome version
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸŽ¯ Biome Explicit Version Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-biome-enabled: "true"
          expected-biome-version: "2.3.6"

      - name: Test Biome
        run: biome --version

  test-turbo-detection:
    name: Turbo - Monorepo detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: turbo-monorepo

      - name: Setup with Turbo detection
        id: setup
        uses: ./

      - name: Verify Turbo detection
        uses: ./.github/actions/verify-setup
        with:
          title: "âš¡ Turbo Detection Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-turbo-enabled: "true"
          expected-turbo-config-file: turbo.json

  test-cache-effectiveness:
    name: Cache - First run vs cached run
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: cache-test

      - name: First run (cache miss)
        id: setup1
        uses: ./

      - name: Verify first run
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ’¾ Cache First Run Results"
          outputs: ${{ toJSON(steps.setup1.outputs) }}

      - name: Verify dependencies installed
        run: |
          if [ ! -d "node_modules/lodash" ]; then
            echo "âŒ Dependencies not installed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… Dependencies installed successfully" >> $GITHUB_STEP_SUMMARY

      - name: Clear node_modules for second run
        run: rm -rf node_modules

      - name: Second run (cache hit expected)
        id: setup2
        uses: ./

      - name: Verify second run
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ’¾ Cache Second Run Results"
          outputs: ${{ toJSON(steps.setup2.outputs) }}

      - name: Verify cache restoration
        run: |
          # Verify cache hit or partial
          if [ "${{ steps.setup2.outputs.cache-hit }}" == "false" ]; then
            echo "âŒ Second run should have cache hit or partial" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verify dependencies still work
          if [ ! -d "node_modules/lodash" ]; then
            echo "âŒ Dependencies not restored from cache" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Cache restoration successful" >> $GITHUB_STEP_SUMMARY

  test-skip-deps:
    name: Skip dependency installation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: cache-test

      - name: Setup with install-deps disabled
        id: setup
        uses: ./
        with:
          install-deps: false

      - name: Verify setup
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸš« Skip Dependencies Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}

      - name: Verify dependencies not installed
        run: |
          # Verify Node.js is installed
          node --version
          npm --version

          # Verify node_modules was NOT created
          if [ -d "node_modules" ]; then
            echo "âŒ node_modules should not exist when install-deps is false" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Dependencies correctly skipped" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Features Tests Summary
    runs-on: ubuntu-latest
    needs:
      [
        test-biome-auto-detect,
        test-biome-explicit,
        test-turbo-detection,
        test-cache-effectiveness,
        test-skip-deps,
      ]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Features Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Biome Auto-detect | ${{ needs.test-biome-auto-detect.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Biome Explicit | ${{ needs.test-biome-explicit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Turbo Detection | ${{ needs.test-turbo-detection.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Effectiveness | ${{ needs.test-cache-effectiveness.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skip Dependencies | ${{ needs.test-skip-deps.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all tests passed
          if [ "${{ needs.test-biome-auto-detect.result }}" == "success" ] && \
             [ "${{ needs.test-biome-explicit.result }}" == "success" ] && \
             [ "${{ needs.test-turbo-detection.result }}" == "success" ] && \
             [ "${{ needs.test-cache-effectiveness.result }}" == "success" ] && \
             [ "${{ needs.test-skip-deps.result }}" == "success" ]; then
            echo "### âœ… All feature tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
