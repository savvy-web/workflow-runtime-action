name: Tests

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - "__fixtures__/**"
      - "./.github/actions/test-fixture/**"
      - ".github/workflows/test.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - "__fixtures__/**"
      - "./.github/actions/test-fixture/**"
      - ".github/workflows/test.yml"

jobs:
  # ============================================================================
  # Node.js Tests
  # ============================================================================
  test-node:
    name: Node.js - ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: NPM
            fixture: node-minimal
            package-manager: npm
            expected-node-enabled: "true"
            expected-package-manager: npm
            test-command: "node --version && npm --version"
            title: "üì¶ NPM Test Results"

          - name: PNPM
            fixture: node-pnpm
            expected-node-enabled: "true"
            expected-package-manager: pnpm
            test-command: "node --version && pnpm --version"
            title: "üì¶ PNPM Test Results"

          - name: Yarn
            fixture: node-yarn
            expected-node-enabled: "true"
            expected-package-manager: yarn
            test-command: "node --version && yarn --version"
            title: "üì¶ Yarn Test Results"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test fixture
        id: test
        uses: ./.github/actions/test-fixture
        with:
          fixture: ${{ matrix.fixture }}
          title: ${{ matrix.title }}
          package-manager: ${{ matrix.package-manager || '' }}
          install-deps: "true"
          expected-node-enabled: ${{ matrix.expected-node-enabled || '' }}
          expected-package-manager: ${{ matrix.expected-package-manager || '' }}

      - name: Test runtime
        if: matrix.test-command != ''
        run: ${{ matrix.test-command }}

      - name: Save test results
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/${{ matrix.name }}.json <<'EOF'
          {
            "name": "${{ matrix.name }}",
            "title": "${{ matrix.title }}",
            "fixture": "${{ matrix.fixture }}",
            "passed": ${{ steps.test.outputs.test-passed }},
            "results": ${{ steps.test.outputs.test-results }}
          }
          EOF

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ strategy.job-index }}
          path: test-results/
          retention-days: 1

  # ============================================================================
  # Bun Tests
  # ============================================================================
  test-bun:
    name: Bun - ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: From devEngines
            fixture: bun-minimal
            expected-bun-enabled: "true"
            expected-package-manager: bun
            test-command: "bun --version && bun run index.ts"
            title: "üöÄ Bun from devEngines Test Results"

          - name: Explicit Version
            fixture: bun-minimal
            package-manager: bun
            package-manager-version: "1.3.3"
            bun-version: "1.3.3"
            expected-bun-enabled: "true"
            expected-bun-version: "1.3.3"
            test-command: "bun --version && bun run test.js"
            title: "üéØ Bun Explicit Version Test Results"

          - name: Lockfile
            fixture: bun-lockfile
            test-command: "bun --version"
            verify-lockfile: bun.lock
            title: "üîí Bun Lockfile Test Results"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test fixture
        id: test
        uses: ./.github/actions/test-fixture
        with:
          fixture: ${{ matrix.fixture }}
          title: ${{ matrix.title }}
          package-manager: ${{ matrix.package-manager || '' }}
          bun-version: ${{ matrix.bun-version || '' }}
          install-deps: "true"
          expected-bun-enabled: ${{ matrix.expected-bun-enabled || '' }}
          expected-bun-version: ${{ matrix.expected-bun-version || '' }}
          expected-package-manager: ${{ matrix.expected-package-manager || '' }}

      - name: Test runtime
        if: matrix.test-command != ''
        run: ${{ matrix.test-command }}

      - name: Verify lockfile
        id: verify-lockfile
        if: matrix.verify-lockfile != ''
        continue-on-error: true
        run: |
          if [ ! -f "${{ matrix.verify-lockfile }}" ]; then
            echo "lockfile-verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "lockfile-verified=true" >> $GITHUB_OUTPUT

      - name: Save test results
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/${{ matrix.name }}.json <<'EOF'
          {
            "name": "${{ matrix.name }}",
            "title": "${{ matrix.title }}",
            "fixture": "${{ matrix.fixture }}",
            "passed": ${{ steps.test.outputs.test-passed }},
            "lockfile_verified": "${{ steps.verify-lockfile.outputs.lockfile-verified || 'n/a' }}",
            "results": ${{ steps.test.outputs.test-results }}
          }
          EOF

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-bun-${{ strategy.job-index }}
          path: test-results/
          retention-days: 1

  # ============================================================================
  # Deno Tests
  # ============================================================================
  test-deno:
    name: Deno - ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Explicit Input
            fixture: deno-minimal
            deno-version: "1.3.3"
            package-manager: deno
            package-manager-version: "1.3.3"
            expected-deno-enabled: "true"
            expected-package-manager: deno
            expected-package-manager-version: "1.3.3"
            expected-deno-version: "1.3.3"
            test-command: "deno --version && deno run main.ts"
            title: "ü¶ï Deno Explicit Input Test Results"

          - name: From devEngines
            fixture: deno-lockfile
            expected-deno-enabled: "true"
            expected-package-manager: npm
            expected-deno-version: "2.5.6"
            test-command: "deno run app.ts"
            title: "üì¶ Deno from devEngines Test Results"

          - name: Explicit Version
            fixture: deno-minimal
            package-manager: deno
            package-manager-version: "1.3.3"
            deno-version: "1.3.3"
            expected-deno-enabled: "true"
            expected-deno-version: "1.3.3"
            expected-package-manager: deno
            test-command: "deno --version && deno run test.ts"
            title: "üéØ Deno Explicit Version Test Results"

          - name: Lockfile
            fixture: deno-lockfile
            package-manager: deno
            package-manager-version: "2.5.6"
            deno-version: "2.5.6"
            test-command: "deno run main.ts"
            verify-lockfile: deno.lock
            expected-deno-enabled: "true"
            expected-deno-version: "2.5.6"
            expected-package-manager: deno
            title: "üîí Deno Lockfile Test Results"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test fixture
        id: test
        uses: ./.github/actions/test-fixture
        with:
          fixture: ${{ matrix.fixture }}
          title: ${{ matrix.title }}
          package-manager: ${{ matrix.package-manager || '' }}
          deno-version: ${{ matrix.deno-version || '' }}
          install-deps: "true"
          expected-deno-enabled: ${{ matrix.expected-deno-enabled || '' }}
          expected-deno-version: ${{ matrix.expected-deno-version || '' }}
          expected-package-manager: ${{ matrix.expected-package-manager || '' }}

      - name: Test runtime
        if: matrix.test-command != ''
        run: ${{ matrix.test-command }}

      - name: Verify lockfile
        id: verify-lockfile
        if: matrix.verify-lockfile != ''
        continue-on-error: true
        run: |
          if [ ! -f "${{ matrix.verify-lockfile }}" ]; then
            echo "lockfile-verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "lockfile-verified=true" >> $GITHUB_OUTPUT

      - name: Save test results
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/${{ matrix.name }}.json <<'EOF'
          {
            "name": "${{ matrix.name }}",
            "title": "${{ matrix.title }}",
            "fixture": "${{ matrix.fixture }}",
            "passed": ${{ steps.test.outputs.test-passed }},
            "lockfile_verified": "${{ steps.verify-lockfile.outputs.lockfile-verified || 'n/a' }}",
            "results": ${{ steps.test.outputs.test-results }}
          }
          EOF

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-deno-${{ strategy.job-index }}
          path: test-results/
          retention-days: 1

  # ============================================================================
  # Feature Tests
  # ============================================================================
  test-features:
    name: Features - ${{ matrix.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: Biome from Config
            fixture: biome-auto
            expected-biome-enabled: "true"
            expected-biome-version: "2.3.6"
            test-command: "biome --version"
            title: "üß¨ Biome from Config Test Results"

          - name: Biome Explicit Version
            fixture: node-minimal
            biome-version: "2.3.6"
            expected-biome-enabled: "true"
            expected-biome-version: "2.3.6"
            test-command: "biome --version"
            title: "üéØ Biome Explicit Version Test Results"

          - name: Turbo Detection
            fixture: turbo-monorepo
            expected-turbo-enabled: "true"
            test-command: "echo 'Turbo detected'"
            title: "‚ö° Turbo Detection Test Results"

          - name: Skip Dependencies
            fixture: cache-test
            install-deps: "false"
            test-command: "node --version && npm --version"
            verify-no-node-modules: "true"
            title: "üö´ Skip Dependencies Test Results"

    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Test fixture
        id: test
        uses: ./.github/actions/test-fixture
        with:
          fixture: ${{ matrix.fixture }}
          title: ${{ matrix.title }}
          biome-version: ${{ matrix.biome-version || '' }}
          install-deps: ${{ matrix.install-deps || 'true' }}
          expected-biome-enabled: ${{ matrix.expected-biome-enabled || '' }}
          expected-biome-version: ${{ matrix.expected-biome-version || '' }}
          expected-turbo-enabled: ${{ matrix.expected-turbo-enabled || '' }}

      - name: Test runtime
        if: matrix.test-command != ''
        run: ${{ matrix.test-command }}

      - name: Verify no node_modules
        id: verify-no-modules
        if: matrix.verify-no-node-modules == 'true'
        continue-on-error: true
        run: |
          if [ -d "node_modules" ]; then
            echo "no-modules-verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "no-modules-verified=true" >> $GITHUB_OUTPUT

      - name: Save test results
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/${{ matrix.name }}.json <<'EOF'
          {
            "name": "${{ matrix.name }}",
            "title": "${{ matrix.title }}",
            "fixture": "${{ matrix.fixture }}",
            "passed": ${{ steps.test.outputs.test-passed }},
            "no_modules_verified": "${{ steps.verify-no-modules.outputs.no-modules-verified || 'n/a' }}",
            "results": ${{ steps.test.outputs.test-results }}
          }
          EOF

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-features-${{ strategy.job-index }}
          path: test-results/
          retention-days: 1

  # ============================================================================
  # Cache Test
  # ============================================================================
  test-cache:
    name: Cache Effectiveness
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup fixture
        run: |
          # Remove repository config files
          rm -f package.json pnpm-workspace.yaml biome.jsonc turbo.json pnpm-lock.yaml deno.json deno.lock
          # Copy fixture files to current directory
          cp -r __fixtures__/cache-test/. .
          # Remove __fixtures__ directory to prevent glob pattern interference
          rm -rf __fixtures__
          echo "‚úì Fixture 'cache-test' prepared"

      - name: First run (cache miss)
        id: setup1
        uses: ./

      - name: Display first run outputs
        run: |
          echo "## üíæ Cache First Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "node-version: ${{ steps.setup1.outputs.node-version }} ‚úîÔ∏è" >> $GITHUB_STEP_SUMMARY
          echo "package-manager: ${{ steps.setup1.outputs.package-manager }} ‚úîÔ∏è" >> $GITHUB_STEP_SUMMARY
          echo "cache-hit: ${{ steps.setup1.outputs.cache-hit }} ‚úîÔ∏è" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Verify dependencies installed
        id: verify-deps
        continue-on-error: true
        run: |
          if [ ! -d "node_modules/lodash" ]; then
            echo "deps-verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          echo "deps-verified=true" >> $GITHUB_OUTPUT

      - name: Clear node_modules for second run
        run: rm -rf node_modules

      - name: Second run (cache hit expected)
        id: setup2
        uses: ./

      - name: Display second run outputs
        run: |
          echo "## üíæ Cache Second Run Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "node-version: ${{ steps.setup2.outputs.node-version }} ‚úîÔ∏è" >> $GITHUB_STEP_SUMMARY
          echo "package-manager: ${{ steps.setup2.outputs.package-manager }} ‚úîÔ∏è" >> $GITHUB_STEP_SUMMARY
          echo "cache-hit: ${{ steps.setup2.outputs.cache-hit }} ‚úîÔ∏è" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

      - name: Verify cache restoration
        id: verify-cache
        continue-on-error: true
        run: |
          if [ "${{ steps.setup2.outputs.cache-hit }}" == "false" ]; then
            echo "cache-verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [ ! -d "node_modules/lodash" ]; then
            echo "cache-verified=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "cache-verified=true" >> $GITHUB_OUTPUT

      - name: Save test results
        if: always()
        run: |
          mkdir -p test-results
          cat > test-results/cache-test.json <<'EOF'
          {
            "name": "Cache Effectiveness",
            "title": "üíæ Cache Effectiveness Test Results",
            "fixture": "cache-test",
            "passed": "${{ steps.verify-deps.outputs.deps-verified == 'true' && steps.verify-cache.outputs.cache-verified == 'true' }}",
            "deps_verified": "${{ steps.verify-deps.outputs.deps-verified || 'false' }}",
            "cache_verified": "${{ steps.verify-cache.outputs.cache-verified || 'false' }}",
            "first_run_cache_hit": "${{ steps.setup1.outputs.cache-hit }}",
            "second_run_cache_hit": "${{ steps.setup2.outputs.cache-hit }}",
            "results": {}
          }
          EOF

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-cache
          path: test-results/
          retention-days: 1

  # ============================================================================
  # Test Summary
  # ============================================================================
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-node, test-bun, test-deno, test-features, test-cache]
    if: always()
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          path: all-results
          merge-multiple: true

      - name: Generate aggregated summary
        run: |
          echo "## üß™ Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          TOTAL=0
          PASSED=0
          FAILED=0

          # Process all JSON result files
          for file in all-results/*.json; do
            if [ -f "$file" ]; then
              TOTAL=$((TOTAL + 1))

              # Extract test info
              name=$(jq -r '.name // "Unknown"' "$file")
              title=$(jq -r '.title // "Unknown"' "$file")
              fixture=$(jq -r '.fixture // "Unknown"' "$file")
              passed=$(jq -r '.passed // "false"' "$file")

              # Count passes/fails
              if [ "$passed" == "true" ]; then
                PASSED=$((PASSED + 1))
                status="‚úÖ"
              else
                FAILED=$((FAILED + 1))
                status="‚ùå"
              fi

              # Show test with title
              echo "### $status $title" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Add expandable details
              echo "<details>" >> $GITHUB_STEP_SUMMARY
              if [ "$passed" == "true" ]; then
                echo "<summary>‚úì Test passed - click to view details</summary>" >> $GITHUB_STEP_SUMMARY
              else
                echo "<summary>‚ö†Ô∏è Test failed - click to view details</summary>" >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY

              # Show test metadata
              echo "**Test:** $name" >> $GITHUB_STEP_SUMMARY
              echo "**Fixture:** \`$fixture\`" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY

              # Parse and display results
              results=$(jq -r '.results // {}' "$file")
              if [ "$results" != "{}" ]; then
                echo "**Results:**" >> $GITHUB_STEP_SUMMARY
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "| Output | Actual | Expected | Status |" >> $GITHUB_STEP_SUMMARY
                echo "|--------|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY

                # Iterate through each result
                jq -r '.results | to_entries | .[] | "\(.key)|\(.value.actual)|\(.value.expected)|\(.value.status)"' "$file" | while IFS='|' read -r key actual expected status; do
                  # Format status with emoji
                  case "$status" in
                    passed) status_icon="‚úÖ" ;;
                    failed) status_icon="‚ùå" ;;
                    info) status_icon="‚ÑπÔ∏è" ;;
                    *) status_icon="‚Äî" ;;
                  esac

                  # Handle empty expected
                  if [ -z "$expected" ]; then
                    expected="‚Äî"
                  fi

                  echo "| \`$key\` | \`$actual\` | \`$expected\` | $status_icon |" >> $GITHUB_STEP_SUMMARY
                done
              fi

              # Show additional verification info if present
              lockfile_verified=$(jq -r '.lockfile_verified // "n/a"' "$file")
              no_modules_verified=$(jq -r '.no_modules_verified // "n/a"' "$file")
              deps_verified=$(jq -r '.deps_verified // "n/a"' "$file")
              cache_verified=$(jq -r '.cache_verified // "n/a"' "$file")

              if [ "$lockfile_verified" != "n/a" ] || [ "$no_modules_verified" != "n/a" ] || [ "$deps_verified" != "n/a" ] || [ "$cache_verified" != "n/a" ]; then
                echo "" >> $GITHUB_STEP_SUMMARY
                echo "**Additional Verifications:**" >> $GITHUB_STEP_SUMMARY
                [ "$lockfile_verified" != "n/a" ] && echo "- Lockfile verified: $lockfile_verified" >> $GITHUB_STEP_SUMMARY
                [ "$no_modules_verified" != "n/a" ] && echo "- No modules verified: $no_modules_verified" >> $GITHUB_STEP_SUMMARY
                [ "$deps_verified" != "n/a" ] && echo "- Dependencies verified: $deps_verified" >> $GITHUB_STEP_SUMMARY
                [ "$cache_verified" != "n/a" ] && echo "- Cache verified: $cache_verified" >> $GITHUB_STEP_SUMMARY
              fi

              echo "" >> $GITHUB_STEP_SUMMARY
              echo "</details>" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Final summary
          if [ $FAILED -eq 0 ]; then
            echo "### ‚úÖ All $TOTAL tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### ‚ùå $FAILED of $TOTAL tests failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Passed:** $PASSED / **Failed:** $FAILED / **Total:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
