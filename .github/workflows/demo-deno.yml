name: Demo - Deno Runtime

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - ".github/workflows/demo-deno.yml"
      - "src/**"
      - "dist/**"

jobs:
  demo-deno-auto-detect:
    name: Deno Auto-Detect (from config)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup isolated test environment
        run: |
          mkdir -p /tmp/test-workspace
          cp -r $GITHUB_WORKSPACE/repo/__fixtures__/deno-minimal/* /tmp/test-workspace/
          cp -r $GITHUB_WORKSPACE/repo/dist /tmp/test-workspace/
          cp $GITHUB_WORKSPACE/repo/action.yml /tmp/test-workspace/

      - name: Setup runtime (auto-detect Deno from deno.json)
        id: setup
        uses: ./
        with:
          deno-version: "1.46.3"

      - name: Show configuration
        run: |
          echo "## ğŸ¦• Deno Auto-Detected Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime(s): ${{ steps.setup.outputs.runtime }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deno Version: ${{ steps.setup.outputs.deno-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Package Manager: ${{ steps.setup.outputs.package-manager }}" >> $GITHUB_STEP_SUMMARY
          echo "- Cache Hit: ${{ steps.setup.outputs.cache-hit }}" >> $GITHUB_STEP_SUMMARY

      - name: Verify Deno installation
        run: |
          deno --version
          deno run main.ts

      - name: Test Deno task runner
        run: deno task start

  demo-deno-from-package-json:
    name: Deno From package.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup isolated test environment
        run: |
          mkdir -p /tmp/test-workspace
          cp -r $GITHUB_WORKSPACE/repo/__fixtures__/multi-runtime/* /tmp/test-workspace/
          cp -r $GITHUB_WORKSPACE/repo/dist /tmp/test-workspace/
          cp $GITHUB_WORKSPACE/repo/action.yml /tmp/test-workspace/

      - name: Setup runtime (auto-detect from package.json)
        id: setup
        uses: ./

      - name: Show configuration
        run: |
          echo "## ğŸ“¦ Deno from package.json" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime(s): ${{ steps.setup.outputs.runtime }}" >> $GITHUB_STEP_SUMMARY
          echo "- Deno Version: ${{ steps.setup.outputs.deno-version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Package Manager: ${{ steps.setup.outputs.package-manager }}" >> $GITHUB_STEP_SUMMARY

      - name: Run TypeScript with Deno
        run: deno run app.ts

  demo-deno-with-dependencies:
    name: Deno With Dependencies
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup isolated test environment
        run: |
          mkdir -p /tmp/test-workspace
          cp -r $GITHUB_WORKSPACE/repo/__fixtures__/deno-minimal/* /tmp/test-workspace/
          cp -r $GITHUB_WORKSPACE/repo/dist /tmp/test-workspace/
          cp $GITHUB_WORKSPACE/repo/action.yml /tmp/test-workspace/

      - name: Setup Deno runtime
        id: setup
        uses: ./
        with:
          package-manager: deno
          deno-version: "1.46.3"

      - name: Verify dependencies are cached
        run: |
          echo "Cache status: ${{ steps.setup.outputs.cache-hit }}"
          deno info server.ts

  demo-deno-multi-platform:
    name: Deno Multi-Platform
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create test Deno project
        shell: bash
        run: |
          # Create minimal project
          echo '{"tasks": {"test": "deno run test.ts"}}' > deno.json
          echo 'console.log("Deno works on ${{ matrix.os }}!");' > test.ts

      - name: Setup Deno runtime
        id: setup
        uses: ./
        with:
          package-manager: deno
          deno-version: "1.46.3"

      - name: Verify Deno works
        run: |
          deno --version
          deno run test.ts
