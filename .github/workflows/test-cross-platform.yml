name: Test - Cross-Platform

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-cross-platform.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-cross-platform.yml"

jobs:
  test-node-cross-platform:
    name: Node.js - ${{ matrix.pm }} on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        pm: [npm, pnpm, yarn]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create test project
        shell: bash
        run: |
          # Remove repository config files
          rm -f package.json pnpm-workspace.yaml biome.jsonc turbo.json pnpm-lock.yaml .nvmrc .node-version

          # Create project based on package manager
          case "${{ matrix.pm }}" in
            npm)
              npm init -y
              echo "package-lock.json" > .gitignore
              ;;
            pnpm)
              cat > package.json <<'EOF'
          {
            "name": "test-${{ matrix.pm }}",
            "version": "1.0.0",
            "packageManager": "pnpm@10.20.0"
          }
          EOF
              ;;
            yarn)
              cat > package.json <<'EOF'
          {
            "name": "test-${{ matrix.pm }}",
            "version": "1.0.0",
            "packageManager": "yarn@4.5.3"
          }
          EOF
              ;;
          esac
          echo 'console.log("Hello from ${{ matrix.os }} with ${{ matrix.pm }}!");' > test.js

      - name: Setup Node.js
        id: setup
        uses: ./
        with:
          node-version: "20.x"

      - name: Verify installation
        shell: bash
        run: |
          echo "OS: ${{ matrix.os }}"
          echo "Package Manager: ${{ matrix.pm }}"
          echo "Runtime: ${{ steps.setup.outputs.runtime }}"
          echo "Node Version: ${{ steps.setup.outputs.node-version }}"
          echo "Package Manager Output: ${{ steps.setup.outputs.package-manager }}"

          # Verify Node.js works
          node --version
          node test.js

          # Verify package manager
          case "${{ matrix.pm }}" in
            npm)
              npm --version
              ;;
            pnpm)
              pnpm --version
              ;;
            yarn)
              yarn --version
              ;;
          esac

  test-bun-cross-platform:
    name: Bun on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create Bun project
        shell: bash
        run: |
          # Remove repository config files
          rm -f package.json pnpm-workspace.yaml biome.jsonc turbo.json pnpm-lock.yaml .nvmrc .node-version

          cat > package.json <<'EOF'
          {
            "name": "test-bun",
            "version": "1.0.0",
            "packageManager": "bun@1.1.42"
          }
          EOF
          echo 'console.log("Bun on ${{ matrix.os }}!");' > test.js

      - name: Setup Bun
        id: setup
        uses: ./

      - name: Verify Bun installation
        shell: bash
        run: |
          echo "OS: ${{ matrix.os }}"
          echo "Runtime: ${{ steps.setup.outputs.runtime }}"
          echo "Bun Version: ${{ steps.setup.outputs.bun-version }}"

          # Verify Bun works
          bun --version
          bun run test.js

  test-deno-cross-platform:
    name: Deno on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create Deno project
        shell: bash
        run: |
          # Remove repository config files
          rm -f package.json pnpm-workspace.yaml biome.jsonc turbo.json pnpm-lock.yaml .nvmrc .node-version deno.json deno.lock

          cat > deno.json <<'EOF'
          {
            "tasks": {
              "start": "deno run test.ts"
            }
          }
          EOF
          echo 'console.log("Deno on ${{ matrix.os }}!");' > test.ts

      - name: Setup Deno
        id: setup
        uses: ./
        with:
          package-manager: deno
          deno-version: "1.46.3"

      - name: Verify Deno installation
        shell: bash
        run: |
          echo "OS: ${{ matrix.os }}"
          echo "Runtime: ${{ steps.setup.outputs.runtime }}"
          echo "Deno Version: ${{ steps.setup.outputs.deno-version }}"

          # Verify Deno works
          deno --version
          deno run test.ts

  test-multi-runtime:
    name: Multi-runtime on ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create multi-runtime project
        shell: bash
        run: |
          # Remove repository config files
          rm -f package.json pnpm-workspace.yaml biome.jsonc turbo.json pnpm-lock.yaml .nvmrc .node-version deno.json deno.lock

          # Create Node.js project with Deno config
          cat > package.json <<'EOF'
          {
            "name": "multi-runtime",
            "version": "1.0.0",
            "packageManager": "pnpm@10.20.0"
          }
          EOF
          cat > deno.json <<'EOF'
          {
            "tasks": {
              "start": "deno run app.ts"
            }
          }
          EOF
          echo 'console.log("Multi-runtime test");' > app.ts

      - name: Setup multi-runtime
        id: setup
        uses: ./
        with:
          deno-version: "1.46.3"

      - name: Verify both runtimes
        shell: bash
        run: |
          echo "OS: ${{ matrix.os }}"
          echo "Runtimes: ${{ steps.setup.outputs.runtime }}"

          # Verify Node.js
          node --version
          pnpm --version

          # Verify Deno
          deno --version

          # Verify runtime output contains both
          if [[ "${{ steps.setup.outputs.runtime }}" != *"node"* ]]; then
            echo "âŒ Expected node in runtime output"
            exit 1
          fi

          if [[ "${{ steps.setup.outputs.runtime }}" != *"deno"* ]]; then
            echo "âŒ Expected deno in runtime output"
            exit 1
          fi

  summary:
    name: Cross-Platform Tests Summary
    runs-on: ubuntu-latest
    needs:
      [
        test-node-cross-platform,
        test-bun-cross-platform,
        test-deno-cross-platform,
        test-multi-runtime,
      ]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Cross-Platform Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Suite | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Node.js (npm, pnpm, yarn) | ${{ needs.test-node-cross-platform.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Bun (all platforms) | ${{ needs.test-bun-cross-platform.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Deno (all platforms) | ${{ needs.test-deno-cross-platform.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Multi-runtime | ${{ needs.test-multi-runtime.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all tests passed
          if [ "${{ needs.test-node-cross-platform.result }}" == "success" ] && \
             [ "${{ needs.test-bun-cross-platform.result }}" == "success" ] && \
             [ "${{ needs.test-deno-cross-platform.result }}" == "success" ] && \
             [ "${{ needs.test-multi-runtime.result }}" == "success" ]; then
            echo "### âœ… All cross-platform tests passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tested Platforms:**" >> $GITHUB_STEP_SUMMARY
            echo "- Ubuntu (Linux)" >> $GITHUB_STEP_SUMMARY
            echo "- macOS" >> $GITHUB_STEP_SUMMARY
            echo "- Windows" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Tested Runtimes:**" >> $GITHUB_STEP_SUMMARY
            echo "- Node.js with npm, pnpm, yarn" >> $GITHUB_STEP_SUMMARY
            echo "- Bun" >> $GITHUB_STEP_SUMMARY
            echo "- Deno" >> $GITHUB_STEP_SUMMARY
            echo "- Multi-runtime (Node.js + Deno)" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
