name: Test - Node.js Runtime

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-node.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-node.yml"

jobs:
  test-npm:
    name: Node.js with NPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create NPM project
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          rm -f pnpm-lock.yaml pnpm-workspace.yaml yarn.lock package-lock.json bun.lockb deno.lock .pnpmfile.cjs
          npm init -y
          echo "package-lock.json" > .gitignore
          cp -r /tmp/action-backup/* .

      - name: Setup Node.js with NPM
        id: setup
        uses: ./
        with:
          package-manager: npm
          node-version: "20.x"

      - name: Verify installation
        run: |
          echo "## ðŸ“¦ NPM Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime: \`${{ steps.setup.outputs.runtime }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: \`${{ steps.setup.outputs.node-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Package Manager: \`${{ steps.setup.outputs.package-manager }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          node --version
          npm --version
          echo "âœ… NPM setup successful" >> $GITHUB_STEP_SUMMARY

  test-pnpm:
    name: Node.js with PNPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create PNPM project
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          rm -f pnpm-lock.yaml pnpm-workspace.yaml yarn.lock package-lock.json bun.lockb deno.lock .pnpmfile.cjs
          cat > package.json <<'EOF'
          {
            "name": "pnpm-test",
            "version": "1.0.0",
            "packageManager": "pnpm@10.20.0"
          }
          EOF
          cp -r /tmp/action-backup/* .

      - name: Setup Node.js with PNPM (auto-detect)
        id: setup
        uses: ./

      - name: Verify installation
        run: |
          echo "## ðŸ“¦ PNPM Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime: \`${{ steps.setup.outputs.runtime }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: \`${{ steps.setup.outputs.node-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Package Manager: \`${{ steps.setup.outputs.package-manager }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          node --version
          pnpm --version
          if [ "${{ steps.setup.outputs.package-manager }}" != "pnpm" ]; then
            echo "âŒ Expected pnpm but got ${{ steps.setup.outputs.package-manager }}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… PNPM auto-detection successful" >> $GITHUB_STEP_SUMMARY

  test-yarn:
    name: Node.js with Yarn
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create Yarn project
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          rm -f pnpm-lock.yaml pnpm-workspace.yaml yarn.lock package-lock.json bun.lockb deno.lock .pnpmfile.cjs
          cat > package.json <<'EOF'
          {
            "name": "yarn-test",
            "version": "1.0.0",
            "packageManager": "yarn@4.5.3"
          }
          EOF
          cp -r /tmp/action-backup/* .

      - name: Setup Node.js with Yarn (auto-detect)
        id: setup
        uses: ./

      - name: Verify installation
        run: |
          echo "## ðŸ“¦ Yarn Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime: \`${{ steps.setup.outputs.runtime }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Node.js: \`${{ steps.setup.outputs.node-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Package Manager: \`${{ steps.setup.outputs.package-manager }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          node --version
          yarn --version
          if [ "${{ steps.setup.outputs.package-manager }}" != "yarn" ]; then
            echo "âŒ Expected yarn but got ${{ steps.setup.outputs.package-manager }}" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… Yarn auto-detection successful" >> $GITHUB_STEP_SUMMARY

  test-version-file:
    name: Node.js Version from .nvmrc
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create project with .nvmrc
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          rm -f pnpm-lock.yaml pnpm-workspace.yaml yarn.lock package-lock.json bun.lockb deno.lock .pnpmfile.cjs
          npm init -y
          echo "20.11.0" > .nvmrc
          cp -r /tmp/action-backup/* .

      - name: Setup Node.js from .nvmrc
        id: setup
        uses: ./

      - name: Verify version file detection
        run: |
          echo "## ðŸ“„ Version File Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Version File: \`${{ steps.setup.outputs.node-version-file }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Version Source: \`${{ steps.setup.outputs.node-version-source }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Detected Version: \`${{ steps.setup.outputs.node-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.setup.outputs.node-version-file }}" != ".nvmrc" ]; then
            echo "âŒ Expected .nvmrc detection" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
          echo "âœ… .nvmrc file detected successfully" >> $GITHUB_STEP_SUMMARY

  test-lts-version:
    name: Node.js LTS Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create minimal project
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          rm -f pnpm-lock.yaml pnpm-workspace.yaml yarn.lock package-lock.json bun.lockb deno.lock .pnpmfile.cjs
          npm init -y
          cp -r /tmp/action-backup/* .

      - name: Setup Node.js LTS
        id: setup
        uses: ./
        with:
          node-version: "lts/*"

      - name: Verify LTS installation
        run: |
          echo "## ðŸ”– LTS Version Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Installed Version: \`${{ steps.setup.outputs.node-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          node --version
          echo "âœ… LTS version installed successfully" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Node.js Tests Summary
    runs-on: ubuntu-latest
    needs: [test-npm, test-pnpm, test-yarn, test-version-file, test-lts-version]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Node.js Runtime Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| NPM | ${{ needs.test-npm.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PNPM | ${{ needs.test-pnpm.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Yarn | ${{ needs.test-yarn.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version File (.nvmrc) | ${{ needs.test-version-file.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LTS Version | ${{ needs.test-lts-version.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all tests passed
          if [ "${{ needs.test-npm.result }}" == "success" ] && \
             [ "${{ needs.test-pnpm.result }}" == "success" ] && \
             [ "${{ needs.test-yarn.result }}" == "success" ] && \
             [ "${{ needs.test-version-file.result }}" == "success" ] && \
             [ "${{ needs.test-lts-version.result }}" == "success" ]; then
            echo "### âœ… All Node.js tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
