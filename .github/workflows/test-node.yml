name: Test - Node.js Runtime

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-node.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-node.yml"

jobs:
  test-npm:
    name: Node.js with NPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: node-minimal

      - name: Setup Node.js with NPM
        id: setup
        uses: ./
        with:
          package-manager: npm
          node-version: "20.x"

      - name: Verify installation
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ“¦ NPM Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-runtime: node
          expected-package-manager: npm

      - name: Test runtime
        run: |
          node --version
          npm --version

  test-pnpm:
    name: Node.js with PNPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: node-pnpm

      - name: Setup Node.js with PNPM (auto-detect)
        id: setup
        uses: ./

      - name: Verify installation
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ“¦ PNPM Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-runtime: node
          expected-package-manager: pnpm

      - name: Test runtime
        run: |
          node --version
          pnpm --version

  test-yarn:
    name: Node.js with Yarn
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: node-yarn

      - name: Setup Node.js with Yarn
        id: setup
        uses: ./

      - name: Verify installation
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ“¦ Yarn Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-runtime: node
          expected-package-manager: yarn

      - name: Test runtime
        run: |
          node --version
          yarn --version

  test-nvm:
    name: Node.js with .nvmrc
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: node-nvm

      - name: Setup Node.js with .nvmrc
        id: setup
        uses: ./

      - name: Verify version file detection
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ“„ .nvmrc File Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-node-version-file: .nvmrc
          expected-node-version: 24.11.0

  test-version-file:
    name: Node.js with .node-version file
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: node-version-file

      - name: Setup Node.js from .node-version file
        id: setup
        uses: ./

      - name: Verify version file detection
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ“„ .node-version File Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-node-version-file: .node-version
          expected-node-version: 24.11.0
  test-lts-version:
    name: Node.js LTS Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: node-minimal

      - name: Setup Node.js LTS
        id: setup
        uses: ./
        with:
          node-version: "lts/*"

      - name: Verify LTS installation
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ”– LTS Version Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}

      - name: Test runtime
        run: node --version

  summary:
    name: Node.js Tests Summary
    runs-on: ubuntu-latest
    needs:
      [
        test-npm,
        test-pnpm,
        test-yarn,
        test-nvm,
        test-version-file,
        test-lts-version,
      ]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Node.js Runtime Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| NPM | ${{ needs.test-npm.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PNPM | ${{ needs.test-pnpm.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Yarn | ${{ needs.test-yarn.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version File (.nvmrc) | ${{ needs.test-nvm.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Version File (.node-version) | ${{ needs.test-version-file.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| LTS Version | ${{ needs.test-lts-version.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all tests passed
          if [ "${{ needs.test-npm.result }}" == "success" ] && \
             [ "${{ needs.test-pnpm.result }}" == "success" ] && \
             [ "${{ needs.test-yarn.result }}" == "success" ] && \
             [ "${{ needs.test-nvm.result }}" == "success" ] && \
             [ "${{ needs.test-version-file.result }}" == "success" ] && \
             [ "${{ needs.test-lts-version.result }}" == "success" ]; then
            echo "### âœ… All Node.js tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
