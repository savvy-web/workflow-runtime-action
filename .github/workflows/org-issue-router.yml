name: Organization Issue Router

# This workflow will trigger for ALL issues/PRs across the organization
# when placed in the .github-private repository
on:
  issues:
    types: [opened, reopened]
  pull_request:
    types: [opened, reopened]

permissions:
  issues: read
  pull-requests: read

jobs:
  route-to-project:
    name: Route to Project
    runs-on: ubuntu-latest
    steps:
      - name: Check repository context
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Organization: ${{ github.repository_owner }}"
          
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Get repository properties
        id: repo-props
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const [owner, repo] = '${{ github.repository }}'.split('/');
            
            const { data: repoData } = await github.rest.repos.get({
              owner,
              repo
            });
            
            const customProps = repoData.custom_properties || {};
            const projectTracking = customProps['project-tracking'];
            const clientId = customProps['client-id'];
            const projectNumber = customProps['project-number'];
            
            console.log(`Repository: ${repoData.full_name}`);
            console.log('Custom properties:', customProps);
            
            const enabled = projectTracking === true || projectTracking === 'true';
            
            if (!enabled) {
              console.log('⏭️  Project tracking not enabled for this repository');
              core.summary.addRaw(`⏭️ Project tracking not enabled for ${repoData.full_name}`);
              await core.summary.write();
            }
            
            core.setOutput('enabled', enabled);
            core.setOutput('client-id', clientId || '');
            core.setOutput('project-number', projectNumber || '1');

      - name: Add to project
        if: steps.repo-props.outputs.enabled == 'true'
        uses: actions/github-script@v8
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const projectNumber = parseInt('${{ steps.repo-props.outputs.project-number }}');
            const org = context.repo.owner;
            const issuePR = context.payload.issue || context.payload.pull_request;
            const contentId = issuePR.node_id;
            const itemNumber = issuePR.number;
            const itemType = context.payload.issue ? 'Issue' : 'Pull Request';
            
            try {
              // Get project ID
              const { organization } = await github.graphql(`
                query($org: String!, $number: Int!) {
                  organization(login: $org) {
                    projectV2(number: $number) {
                      id
                      title
                    }
                  }
                }
              `, { org, number: projectNumber });
              
              const projectId = organization.projectV2.id;
              const projectTitle = organization.projectV2.title;
              
              // Add item to project
              await github.graphql(`
                mutation($projectId: ID!, $contentId: ID!) {
                  addProjectV2ItemById(input: {
                    projectId: $projectId
                    contentId: $contentId
                  }) {
                    item {
                      id
                    }
                  }
                }
              `, { projectId, contentId });
              
              console.log(`✅ Added ${itemType} #${itemNumber} from ${context.repo.repo} to project "${projectTitle}"`);
              
              core.summary.addRaw(`✅ Added ${itemType} [#${itemNumber}](${issuePR.html_url}) to [${projectTitle}](https://github.com/orgs/${org}/projects/${projectNumber})`);
              await core.summary.write();
              
            } catch (error) {
              if (error.message.includes('already exists')) {
                console.log(`ℹ️  ${itemType} #${itemNumber} already in project`);
                core.summary.addRaw(`ℹ️ ${itemType} #${itemNumber} already in project`);
                await core.summary.write();
              } else {
                console.error(`❌ Failed to add to project: ${error.message}`);
                core.setFailed(`Failed to add to project: ${error.message}`);
              }
            }