name: Workflow Release
# Reusable workflow for simple single-package releases
# Uses changesets for versioning and creates GitHub releases (no NPM publishing)
# Perfect for private repos, GitHub Actions, or non-NPM packages

on:
  workflow_call:
    inputs:
      version-command:
        description: Custom version command (defaults to package-manager-specific ci:version)
        type: string
        required: false
        default: ""
      pr-title-prefix:
        description: Prefix for release PR title
        type: string
        required: false
        default: "chore: release"
      turbo-token:
        description: Turbo cache token
        type: string
        required: false
        default: ""
      turbo-team:
        description: Turbo team name
        type: string
        required: false
        default: ""
    secrets:
      APP_ID:
        description: GitHub App ID for authentication
        required: true
      APP_PRIVATE_KEY:
        description: GitHub App private key
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    env:
      DO_NOT_TRACK: "1"
      TURBO_TELEMETRY_DISABLE: "1"
    steps:
      - name: Generate GitHub App token
        id: app-token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}
          permission-actions: write
          permission-contents: write
          permission-pull-requests: write
          permission-issues: write

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          token: ${{ steps.app-token.outputs.token }}
          fetch-tags: true

      - name: Detect runtime
        id: detect-runtime
        uses: savvy-web/.github-private/.github/actions/detect-runtime@feature/setup-flow

      - name: Validate runtime
        if: steps.detect-runtime.outputs.runtime != 'node'
        run: |
          echo "::error::Unsupported runtime: ${{ steps.detect-runtime.outputs.runtime }}"
          echo "::error::This workflow only supports Node.js runtime. Detected: ${{ steps.detect-runtime.outputs.runtime }}"
          exit 1

      - name: Setup Node.js and dependencies
        id: setup-node
        uses: savvy-web/.github-private/.github/actions/node@feature/setup-flow
        with:
          package-manager: ${{ steps.detect-runtime.outputs.package-manager }}
          turbo-token: ${{ inputs.turbo-token }}
          turbo-team: ${{ inputs.turbo-team }}

      - name: Setup Biome
        id: biome
        uses: savvy-web/.github-private/.github/actions/biome@feature/setup-flow

      - name: Detect repository type
        id: detect-repo-type
        uses: actions/github-script@v8
        with:
          script: |
            const workspaceTools = require('workspace-tools');
            const { default: detectRepoType } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/detect-repo-type.ts');
            await detectRepoType({ core, workspaceTools });

      # PHASE 1: Release Branch Management (runs on push to main)
      - name: Detect publishable changes
        id: detect-changes
        if: github.ref == 'refs/heads/main'
        uses: actions/github-script@v8
        env:
          PACKAGE_MANAGER: ${{ steps.detect-runtime.outputs.package-manager }}
          DRY_RUN: "false"
        with:
          script: |
            const { default: detectPublishableChanges } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/detect-publishable-changes.ts');
            await detectPublishableChanges({ core, exec, github, context });

      - name: Check release branch
        id: check-branch
        if: github.ref == 'refs/heads/main' && steps.detect-changes.outputs.has_changes == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            const { default: checkReleaseBranch } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/check-release-branch.ts');
            await checkReleaseBranch({ core, github, context });

      - name: Create release branch
        id: create-branch
        if: github.ref == 'refs/heads/main' && steps.check-branch.outputs.exists == 'false'
        uses: actions/github-script@v8
        env:
          PACKAGE_MANAGER: ${{ steps.detect-runtime.outputs.package-manager }}
          BIOME_COMMAND: ${{ steps.biome.outputs.biome-command }}
          PR_TITLE_PREFIX: ${{ inputs.pr-title-prefix }}
        with:
          script: |
            const { default: createReleaseBranch } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/create-release-branch.ts');
            await createReleaseBranch({ core, exec, github, context });

      - name: Update release branch
        id: update-branch
        if: github.ref == 'refs/heads/main' && steps.check-branch.outputs.exists == 'true'
        uses: actions/github-script@v8
        env:
          PACKAGE_MANAGER: ${{ steps.detect-runtime.outputs.package-manager }}
          BIOME_COMMAND: ${{ steps.biome.outputs.biome-command }}
        with:
          script: |
            const { default: updateReleaseBranch } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/update-release-branch.ts');
            await updateReleaseBranch({ core, exec, github, context });

      # PHASE 2: Release Validation (runs on push to changeset-release/main)
      - name: Link issues from commits
        id: link-issues
        if: startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        with:
          script: |
            const { default: linkIssuesFromCommits } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/link-issues-from-commits.ts');
            await linkIssuesFromCommits({ core, exec, github, context });

      - name: Generate PR description
        id: generate-description
        if: startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        env:
          LINKED_ISSUES: ${{ steps.link-issues.outputs.linked_issues }}
          COMMITS: ${{ steps.link-issues.outputs.commits }}
        with:
          script: |
            const { default: generatePRDescription } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/generate-pr-description.ts');
            await generatePRDescription({ core, github, context });

      - name: Validate builds
        id: validate-builds
        if: startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        env:
          PACKAGE_MANAGER: ${{ steps.detect-runtime.outputs.package-manager }}
        with:
          script: |
            const { default: validateBuilds } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/validate-builds.ts');
            await validateBuilds({ core, exec, github, context });

      - name: Validate NPM publish
        id: validate-npm
        if: startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        env:
          PACKAGE_MANAGER: ${{ steps.detect-runtime.outputs.package-manager }}
        with:
          script: |
            const { default: validatePublishNPM } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/validate-publish-npm.ts');
            await validatePublishNPM({ core, exec, github, context });

      - name: Validate GitHub Packages publish
        id: validate-github-packages
        if: startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        env:
          PACKAGE_MANAGER: ${{ steps.detect-runtime.outputs.package-manager }}
        with:
          script: |
            const { default: validatePublishGitHubPackages } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/validate-publish-github-packages.ts');
            await validatePublishGitHubPackages({ core, exec, github, context });

      - name: Generate release notes preview
        id: release-notes
        if: startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        with:
          script: |
            const { default: generateReleaseNotesPreview } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/generate-release-notes-preview.ts');
            await generateReleaseNotesPreview({ core, github, context });

      - name: Create validation check
        id: validation-check
        if: startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        env:
          BUILD_SUCCESS: ${{ steps.validate-builds.outputs.success }}
          NPM_SUCCESS: ${{ steps.validate-npm.outputs.success }}
          GITHUB_PACKAGES_SUCCESS: ${{ steps.validate-github-packages.outputs.success }}
        with:
          script: |
            const { default: createValidationCheck } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/create-validation-check.ts');
            await createValidationCheck({ core, github, context });

      - name: Update sticky comment
        id: sticky-comment
        if: startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        env:
          BUILD_SUCCESS: ${{ steps.validate-builds.outputs.success }}
          NPM_SUCCESS: ${{ steps.validate-npm.outputs.success }}
          GITHUB_PACKAGES_SUCCESS: ${{ steps.validate-github-packages.outputs.success }}
        with:
          script: |
            const { default: updateStickyComment } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/update-sticky-comment.ts');
            await updateStickyComment({ core, github, context });

      # Cleanup on failure
      - name: Cleanup validation checks
        if: failure() && startsWith(github.ref, 'refs/heads/changeset-release/')
        uses: actions/github-script@v8
        with:
          script: |
            const { default: cleanupValidationChecks } = await import('/home/runner/work/_actions/savvy-web/.github-private/feature/setup-flow/.github/actions/setup-release/cleanup-validation-checks.ts');
            await cleanupValidationChecks({ core, github, context });
