name: Test with Fixture Repositories

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"

jobs:
  # Test with minimal npm project
  test-npm-minimal:
    name: NPM - Minimal Project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action
        uses: actions/checkout@v4

      - name: Create test project files
        run: |
          # Backup action files
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/

          # Clear workspace and create minimal npm project
          rm -rf ./*
          npm init -y
          echo "console.log('Hello from npm project');" > index.js

          # Restore action files
          cp -r /tmp/action-backup/* .

      - name: Run action
        id: setup
        uses: ./
        with:
          package-manager: npm
          node-version: "20.x"

      - name: Verify setup
        run: |
          node --version
          npm --version
          echo "âœ… NPM project setup successful"

  # Test with pnpm project
  test-pnpm:
    name: PNPM - With Workspace
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action
        uses: actions/checkout@v4

      - name: Create pnpm workspace
        run: |
          # Backup action files
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/

          # Create pnpm project
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "pnpm-workspace-test",
            "version": "1.0.0",
            "packageManager": "pnpm@10.20.0"
          }
          EOF
          cat > pnpm-workspace.yaml <<'EOF'
          packages:
            - 'packages/*'
          EOF

          # Restore action files
          cp -r /tmp/action-backup/* .

      - name: Run action
        id: setup
        uses: ./
        with:
          package-manager: pnpm

      - name: Verify setup
        run: |
          node --version
          pnpm --version
          echo "âœ… PNPM workspace setup successful"

  # Test with yarn project
  test-yarn:
    name: Yarn - Modern Project
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action
        uses: actions/checkout@v4

      - name: Create yarn project
        run: |
          # Backup action files
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/

          # Create yarn project
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "yarn-test",
            "version": "1.0.0",
            "packageManager": "yarn@4.5.3"
          }
          EOF

          # Restore action files
          cp -r /tmp/action-backup/* .

      - name: Run action
        id: setup
        uses: ./
        with:
          package-manager: yarn

      - name: Verify setup
        run: |
          node --version
          yarn --version
          echo "âœ… Yarn project setup successful"

  # Test with Biome configuration
  test-biome:
    name: Biome - Auto-detect Version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action
        uses: actions/checkout@v4

      - name: Create project with Biome
        run: |
          # Backup action files
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/

          # Create project with biome config
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "biome-test",
            "version": "1.0.0",
            "packageManager": "pnpm@10.20.0"
          }
          EOF
          cat > biome.jsonc <<'EOF'
          {
            "$schema": "https://biomejs.dev/schemas/2.3.6/schema.json",
            "linter": {
              "enabled": true
            }
          }
          EOF
          mkdir src
          echo "console.log('test');" > src/index.js

          # Restore action files
          cp -r /tmp/action-backup/* .

      - name: Run action (auto-detect Biome)
        id: setup
        uses: ./

      - name: Verify Biome installation
        run: |
          biome --version
          biome check src/ || true
          echo "âœ… Biome auto-detected: ${{ steps.setup.outputs.biome-version }}"

  # Test with Turbo configuration
  test-turbo:
    name: Turbo - Monorepo
    runs-on: ubuntu-latest
    steps:
      - name: Checkout action
        uses: actions/checkout@v4

      - name: Create Turbo monorepo
        run: |
          # Backup action files
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/

          # Create turbo monorepo
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "turbo-monorepo",
            "version": "1.0.0",
            "packageManager": "pnpm@10.20.0"
          }
          EOF
          cat > turbo.json <<'EOF'
          {
            "$schema": "https://turbo.build/schema.json",
            "tasks": {
              "build": {
                "outputs": ["dist/**"]
              }
            }
          }
          EOF
          cat > pnpm-workspace.yaml <<'EOF'
          packages:
            - 'apps/*'
          EOF

          # Restore action files
          cp -r /tmp/action-backup/* .

      - name: Run action
        id: setup
        uses: ./

      - name: Verify Turbo detection
        run: |
          echo "Turbo enabled: ${{ steps.setup.outputs.turbo-enabled }}"
          echo "Turbo config: ${{ steps.setup.outputs.turbo-config-file }}"
          if [ "${{ steps.setup.outputs.turbo-enabled }}" != "true" ]; then
            echo "âŒ Turbo should have been detected"
            exit 1
          fi
          echo "âœ… Turbo monorepo detected successfully"

  # Summary job
  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs:
      - test-npm-minimal
      - test-pnpm
      - test-yarn
      - test-biome
      - test-turbo
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Fixture Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| NPM Minimal | ${{ needs.test-npm-minimal.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| PNPM Workspace | ${{ needs.test-pnpm.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Yarn Modern | ${{ needs.test-yarn.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Biome Auto-detect | ${{ needs.test-biome.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Turbo Monorepo | ${{ needs.test-turbo.result == 'success' && 'âœ…' || 'âŒ' }} |" >> $GITHUB_STEP_SUMMARY
