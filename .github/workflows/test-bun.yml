name: Test - Bun Runtime

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-bun.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-bun.yml"

jobs:
  test-bun-auto-detect:
    name: Bun - Auto-detect from package.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create Bun project
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "bun-test",
            "version": "1.0.0",
            "packageManager": "bun@1.1.42"
          }
          EOF
          cat > index.ts <<'EOF'
          console.log("Hello from Bun!");
          console.log(`Bun version: ${Bun.version}`);
          EOF
          cp -r /tmp/action-backup/* .

      - name: Setup Bun (auto-detect)
        id: setup
        uses: ./

      - name: Verify Bun installation
        run: |
          echo "## ðŸš€ Bun Auto-detect Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Runtime: \`${{ steps.setup.outputs.runtime }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Bun Version: \`${{ steps.setup.outputs.bun-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Package Manager: \`${{ steps.setup.outputs.package-manager }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify Bun is installed
          bun --version

          # Verify package manager is bun
          if [ "${{ steps.setup.outputs.package-manager }}" != "bun" ]; then
            echo "âŒ Expected bun package manager" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Verify runtime output
          if [ "${{ steps.setup.outputs.runtime }}" != "bun" ]; then
            echo "âŒ Expected bun runtime" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Run TypeScript file
          bun run index.ts

          echo "âœ… Bun auto-detection successful" >> $GITHUB_STEP_SUMMARY

  test-bun-explicit:
    name: Bun - Explicit version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create project
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          npm init -y
          echo 'console.log("Bun explicit version test");' > test.js
          cp -r /tmp/action-backup/* .

      - name: Setup Bun (explicit version)
        id: setup
        uses: ./
        with:
          package-manager: bun
          bun-version: "1.1.42"

      - name: Verify Bun installation
        run: |
          echo "## ðŸŽ¯ Bun Explicit Version Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Bun Version: \`${{ steps.setup.outputs.bun-version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify version
          INSTALLED_VERSION=$(bun --version)
          echo "Installed: $INSTALLED_VERSION"

          if [ "${{ steps.setup.outputs.bun-version }}" != "1.1.42" ]; then
            echo "âŒ Expected version 1.1.42" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          bun run test.js
          echo "âœ… Explicit version installation successful" >> $GITHUB_STEP_SUMMARY

  test-bun-package-install:
    name: Bun - Package installation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create project with dependencies
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "bun-deps-test",
            "version": "1.0.0",
            "packageManager": "bun@1.1.42",
            "dependencies": {
              "lodash": "^4.17.21"
            }
          }
          EOF
          cat > test.js <<'EOF'
          const _ = require('lodash');
          console.log(_.capitalize('hello from bun with lodash'));
          EOF
          cp -r /tmp/action-backup/* .

      - name: Setup Bun and install dependencies
        id: setup
        uses: ./
        with:
          install-deps: true

      - name: Verify dependencies
        run: |
          echo "## ðŸ“¦ Bun Package Installation Test" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check node_modules exists
          if [ ! -d "node_modules" ]; then
            echo "âŒ node_modules not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Run test file
          bun run test.js

          echo "âœ… Dependencies installed successfully" >> $GITHUB_STEP_SUMMARY

  test-bun-lockfile:
    name: Bun - Lock file handling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Create project with bun.lockb
        run: |
          mkdir -p /tmp/action-backup
          cp -r dist action.yml /tmp/action-backup/
          rm -rf ./*
          cat > package.json <<'EOF'
          {
            "name": "bun-lockfile-test",
            "version": "1.0.0",
            "packageManager": "bun@1.1.42"
          }
          EOF
          # Create empty lockfile
          touch bun.lockb
          cp -r /tmp/action-backup/* .

      - name: Setup Bun with lockfile
        id: setup
        uses: ./

      - name: Verify lockfile detection
        run: |
          echo "## ðŸ”’ Bun Lockfile Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Verify bun.lockb exists
          if [ ! -f "bun.lockb" ]; then
            echo "âŒ bun.lockb not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Lockfile handled correctly" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Bun Tests Summary
    runs-on: ubuntu-latest
    needs:
      [
        test-bun-auto-detect,
        test-bun-explicit,
        test-bun-package-install,
        test-bun-lockfile,
      ]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Bun Runtime Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-detect | ${{ needs.test-bun-auto-detect.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Explicit Version | ${{ needs.test-bun-explicit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Install | ${{ needs.test-bun-package-install.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lockfile Handling | ${{ needs.test-bun-lockfile.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all tests passed
          if [ "${{ needs.test-bun-auto-detect.result }}" == "success" ] && \
             [ "${{ needs.test-bun-explicit.result }}" == "success" ] && \
             [ "${{ needs.test-bun-package-install.result }}" == "success" ] && \
             [ "${{ needs.test-bun-lockfile.result }}" == "success" ]; then
            echo "### âœ… All Bun tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
