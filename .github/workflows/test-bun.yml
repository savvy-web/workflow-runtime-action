name: Test - Bun Runtime

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-bun.yml"
  pull_request:
    paths:
      - "src/**"
      - "dist/**"
      - "action.yml"
      - ".github/workflows/test-bun.yml"

jobs:
  test-bun-auto-detect:
    name: Bun - Auto-detect from package.json
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: bun-minimal

      - name: Setup Bun (auto-detect)
        id: setup
        uses: ./

      - name: Verify Bun installation
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸš€ Bun Auto-detect Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-runtime: bun
          expected-package-manager: bun

      - name: Test Bun
        run: |
          bun --version
          bun run index.ts

  test-bun-explicit:
    name: Bun - Explicit version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: bun-minimal

      - name: Setup Bun (explicit version)
        id: setup
        uses: ./
        with:
          package-manager: bun
          bun-version: "1.1.42"

      - name: Verify Bun installation
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸŽ¯ Bun Explicit Version Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}
          expected-bun-version: "1.1.42"

      - name: Test Bun
        run: |
          bun --version
          bun run test.js

  test-bun-package-install:
    name: Bun - Package installation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: bun-deps

      - name: Setup Bun and install dependencies
        id: setup
        uses: ./
        with:
          install-deps: true

      - name: Verify setup
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ“¦ Bun Package Installation Test"
          outputs: ${{ toJSON(steps.setup.outputs) }}

      - name: Verify dependencies
        run: |
          # Check node_modules exists
          if [ ! -d "node_modules" ]; then
            echo "âŒ node_modules not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          # Run test file
          bun run test.js

          echo "âœ… Dependencies installed successfully" >> $GITHUB_STEP_SUMMARY

  test-bun-lockfile:
    name: Bun - Lock file handling
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup test fixture
        uses: ./.github/actions/setup-fixture
        with:
          fixture: bun-lockfile

      - name: Setup Bun with lockfile
        id: setup
        uses: ./

      - name: Verify setup
        uses: ./.github/actions/verify-setup
        with:
          title: "ðŸ”’ Bun Lockfile Test Results"
          outputs: ${{ toJSON(steps.setup.outputs) }}

      - name: Verify lockfile
        run: |
          # Verify bun.lockb exists
          if [ ! -f "bun.lockb" ]; then
            echo "âŒ bun.lockb not found" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

          echo "âœ… Lockfile handled correctly" >> $GITHUB_STEP_SUMMARY

  summary:
    name: Bun Tests Summary
    runs-on: ubuntu-latest
    needs:
      [
        test-bun-auto-detect,
        test-bun-explicit,
        test-bun-package-install,
        test-bun-lockfile,
      ]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ§ª Bun Runtime Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Auto-detect | ${{ needs.test-bun-auto-detect.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Explicit Version | ${{ needs.test-bun-explicit.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Package Install | ${{ needs.test-bun-package-install.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lockfile Handling | ${{ needs.test-bun-lockfile.result == 'success' && 'âœ… Pass' || 'âŒ Fail' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check if all tests passed
          if [ "${{ needs.test-bun-auto-detect.result }}" == "success" ] && \
             [ "${{ needs.test-bun-explicit.result }}" == "success" ] && \
             [ "${{ needs.test-bun-package-install.result }}" == "success" ] && \
             [ "${{ needs.test-bun-lockfile.result }}" == "success" ]; then
            echo "### âœ… All Bun tests passed!" >> $GITHUB_STEP_SUMMARY
            exit 0
          else
            echo "### âŒ Some tests failed" >> $GITHUB_STEP_SUMMARY
            exit 1
          fi
